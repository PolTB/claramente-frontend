<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClaraFlow - Decisiones Claras</title>
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            padding: 10px;
        }

        /* LAYOUT & GLASSMORPHISM */
        .app-container {
            width: 100%;
            max-width: 480px;
            height: 90vh;
            max-height: 850px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* TOPBAR */
        .topbar {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-area h1 { font-size: 1.2rem; font-weight: 700; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .logo-area p { font-size: 0.75rem; color: rgba(255,255,255,0.9); }
        .status-badge {
            font-size: 0.7rem;
            background: rgba(0,0,0,0.2);
            color: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            font-family: monospace;
        }

        /* MAIN CONTENT AREA */
        .view-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none; /* Oculto por defecto */
            flex-direction: column;
        }
        .view-container.active { display: flex; }

        /* BUTTONS & INPUTS */
        button {
            cursor: pointer;
            border: none;
            outline: none;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary {
            background: #fff;
            color: #667eea;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 18px;
            width: 100%;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 14px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .btn-text {
            background: transparent;
            color: #eee;
            text-decoration: underline;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .btn-disabled { opacity: 0.5; pointer-events: none; }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.6);
            font-family: inherit;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        input:focus, textarea:focus { outline: none; background: rgba(255,255,255,0.9); }

        /* VISTA 1: ONBOARDING */
        #viewOnboarding { justify-content: center; text-align: center; color: #fff; }
        .onboarding-step { display: none; animation: fadeIn 0.5s ease; }
        .onboarding-step.active-step { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .step-counter { font-size: 0.8rem; opacity: 0.8; margin-bottom: 10px; }
        .onboarding-title { font-size: 1.8rem; margin-bottom: 10px; }
        .onboarding-text { font-size: 1.1rem; line-height: 1.5; margin-bottom: 20px; max-width: 90%; }
        .onboarding-list { text-align: left; list-style: none; margin-bottom: 20px; background: rgba(0,0,0,0.1); padding: 15px; border-radius: 16px; }
        .onboarding-list li { margin-bottom: 8px; display: flex; align-items: center; }
        .onboarding-list li::before { content: "‚úì"; margin-right: 10px; font-weight: bold; }

        /* VISTA 2: DASHBOARD */
        .dashboard-card {
            background: rgba(255,255,255,0.5);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        .dashboard-title { font-size: 1.2rem; margin-bottom: 15px; color: #4a5568; font-weight: bold; }
        .info-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px; }
        .info-label { color: #666; }
        .info-val { font-family: monospace; color: #333; }

        /* VISTA 3: CLARIFICACION */
        #viewClarification { justify-content: center; }
        .clarify-card {
            background: rgba(255,255,255,0.8);
            padding: 25px;
            border-radius: 22px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .clarify-title { font-size: 1.5rem; color: #2d3748; margin-bottom: 10px; }
        .clarify-desc { color: #4a5568; margin-bottom: 20px; line-height: 1.4; }

        /* VISTA 4: CHAT */
        #viewChat { padding: 0; display: none; flex-direction: column; height: 100%; }
        .chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chat-input-area {
            padding: 15px;
            background: rgba(255,255,255,0.6);
            border-top: 1px solid rgba(255,255,255,0.3);
            display: flex;
            gap: 10px;
        }
        
        /* CHAT BUBBLES */
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; line-height: 1.4; font-size: 0.95rem; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .msg-user { align-self: flex-end; background: #4c51bf; color: white; border-bottom-right-radius: 4px; }
        .msg-bot { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .msg-system { align-self: center; background: rgba(254, 252, 191, 0.9); color: #744210; font-size: 0.85rem; text-align: center; border: 1px solid rgba(246, 224, 94, 0.5); width: 90%; }
        .msg-error { background: #fed7d7; color: #742a2a; align-self: center; width: 90%; text-align: center; border: 1px solid #fc8181; }

        /* FOOTER */
        .footer {
            padding: 10px;
            text-align: center;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="topbar">
            <div class="logo-area">
                <h1>CF ClaraFlow</h1>
                <p>Decisiones claras, paso a paso</p>
            </div>
            <div class="status-badge" id="statusIndicator">Ready</div>
        </div>

        <div id="viewOnboarding" class="view-container">
            <div class="onboarding-step active-step" id="step1">
                <div class="step-counter">Paso 1/4</div>
                <h2 class="onboarding-title">¬°Bienvenido a ClaraFlow! üéØ</h2>
                <p class="onboarding-text">ClaraFlow te ayuda a tomar decisiones claras y organizadas mediante un sistema inteligente de flujo de trabajo.</p>
                <button class="btn-primary" onclick="nextStep(2)">Continuar</button>
            </div>

            <div class="onboarding-step" id="step2">
                <div class="step-counter">Paso 2/4</div>
                <h2 class="onboarding-title">¬øC√≥mo funciona? ü§î</h2>
                <ul class="onboarding-list">
                    <li>Crea una sesi√≥n de trabajo</li>
                    <li>Define tu decisi√≥n</li>
                    <li>Sigue el flujo guiado</li>
                    <li>Obt√©n claridad en tus decisiones</li>
                </ul>
                <button class="btn-primary" onclick="nextStep(3)">Siguiente</button>
            </div>

            <div class="onboarding-step" id="step3">
                <div class="step-counter">Paso 3/4</div>
                <h2 class="onboarding-title">Tu privacidad importa üîí</h2>
                <p class="onboarding-text">Todas tus decisiones se guardan de forma segura. Solo t√∫ tienes acceso a tu informaci√≥n.</p>
                <button class="btn-primary" onclick="nextStep(4)">Entendido</button>
            </div>

            <div class="onboarding-step" id="step4">
                <div class="step-counter">Paso 4/4</div>
                <h2 class="onboarding-title">¬°Listo para empezar! üöÄ</h2>
                <p class="onboarding-text">Vamos a comenzar tu primera sesi√≥n de ClaraFlow.</p>
                <button class="btn-primary" onclick="finishOnboarding()">Comenzar</button>
            </div>
        </div>

        <div id="viewDashboard" class="view-container">
            <div class="dashboard-card">
                <h3 class="dashboard-title">Nueva Sesi√≥n</h3>
                <p style="margin-bottom:15px; color:#666;">Inicia un nuevo ciclo de pensamiento.</p>
                <button class="btn-primary" onclick="startSession()">Iniciar Sesi√≥n de Trabajo</button>
            </div>

            <div class="dashboard-card" id="activeSessionCard" style="display:none; border-left: 4px solid #48bb78;">
                <h3 class="dashboard-title">Sesi√≥n Activa</h3>
                <button class="btn-primary" onclick="showView('viewClarification')">Ir a Clarificaci√≥n</button>
            </div>

            <div class="dashboard-card">
                <h3 class="dashboard-title">Diagn√≥stico</h3>
                <div class="info-row">
                    <span class="info-label">User ID:</span>
                    <span class="info-val" id="dispUserId">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Session ID:</span>
                    <span class="info-val" id="dispSessionId">Ninguna</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Onboarding:</span>
                    <span class="info-val" id="dispOnboarding">...</span>
                </div>
                <button class="btn-secondary" style="width:100%; margin-top:15px; background: rgba(229, 62, 62, 0.2); color: #c53030;" onclick="resetLocal()">Reset Local & Reload</button>
            </div>

            <div id="decisionArea" class="dashboard-card hidden">
                <h3 class="dashboard-title">Registrar Decisi√≥n Final</h3>
                <input type="text" id="decisionText" placeholder="Decisi√≥n final tomada...">
                <button class="btn-primary" onclick="registerDecision()">Registrar Decisi√≥n</button>
            </div>
        </div>

        <div id="viewClarification" class="view-container">
            <div class="clarify-card">
                <h2 class="clarify-title">Aclaremos una cosa</h2>
                <p class="clarify-desc">No hace falta contarlo todo. Piensa en una situaci√≥n, decisi√≥n o asunto concreto que ahora mismo te genera ruido. Vamos a mirarlo con calma para ganar un poco m√°s de claridad.</p>
                
                <textarea id="clarificationInput" rows="4" placeholder="Cu√©ntame qu√© est√° pasando..."></textarea>
                
                <button class="btn-primary" id="btnSendClarification" onclick="handleFirstMessage()">Enviar</button>
                <button class="btn-text" onclick="showView('viewDashboard')">Volver al Dashboard</button>
            </div>
        </div>

        <div id="viewChat" class="view-container">
            <div class="chat-history" id="chatHistory">
                </div>
            
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." onkeypress="handleEnter(event)">
                <button class="btn-primary" style="width: auto; padding: 10px 20px;" onclick="sendChatMessage()">Enviar</button>
            </div>
            <div style="text-align:center; padding-bottom:10px; background: rgba(255,255,255,0.6);">
                <button class="btn-text" style="color: #555; font-size: 0.75rem;" onclick="showView('viewClarification')">Volver a Clarificaci√≥n</button>
                <button class="btn-text" style="color: #555; font-size: 0.75rem; margin-left: 10px;" onclick="showView('viewDashboard')">Volver al Dashboard</button>
            </div>
        </div>

        <div class="footer">
            <p>ClaraFlow ‚Ä¢ Single-file HTML ‚Ä¢ Sin dependencias</p>
            <p style="opacity: 0.6; margin-top: 4px;" id="debugFooter">Debug: Loading...</p>
        </div>
    </div>

    <script>
        // --- CONSTANTES DEL BACKEND ---
        const SESSION_URL = 'https://claramente-edge-prod.vercel.app/api/clara-flow-session';
        const IF_URL = 'https://claramente-edge-prod.vercel.app/api/if-loop-message';
        const DECIDE_URL = 'https://claramente-edge-prod.vercel.app/api/claraflow-decide';
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRramVwc3FncXRqbWlieGdhaXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MDU4NDcsImV4cCI6MjA1MzM4MTg0N30.YH0RfmwXc3FncXRQqbHlidGdhX1pEzNTI3NzcyNy1jYzE2LTQ0YjgtYmZjMi1iZTEzMDg3N2Y3ZmE";

        // --- VARIABLES GLOBALES ---
        let currentSessionId = null;
        let currentUserId = localStorage.getItem('claraflow_userid') || 'demo-user-' + Date.now();
        // Guardamos el usuario para persistencia b√°sica
        if(!localStorage.getItem('claraflow_userid')) {
            localStorage.setItem('claraflow_userid', currentUserId);
        }

        let isFirstMessage = true;

        // --- INICIALIZACI√ìN ---
        window.onload = function() {
            logAction('INIT', 'Aplicaci√≥n iniciada');
            checkOnboarding();
            updateDebugInfo();
            
            // Chequeo si hay sesi√≥n guardada en memoria (opcional, pero buena pr√°ctica si refrescan)
            const savedSession = localStorage.getItem('claraflow_session_id');
            if(savedSession) {
                currentSessionId = savedSession;
                document.getElementById('decisionArea').classList.remove('hidden');
                document.getElementById('activeSessionCard').style.display = 'block';
                logAction('SESSION', 'Sesi√≥n recuperada de storage: ' + currentSessionId);
            }
        };

        // --- LOGS Y UTILIDADES ---
        function logAction(action, desc) {
            console.log(`[${action}] ${desc}`);
        }

        function updateDebugInfo() {
            const onbStatus = localStorage.getItem('claraflow_onboarding_complete');
            document.getElementById('dispUserId').innerText = currentUserId.substring(0, 15) + '...';
            document.getElementById('dispSessionId').innerText = currentSessionId ? currentSessionId.substring(0, 8) + '...' : 'Ninguna';
            document.getElementById('dispOnboarding').innerText = onbStatus === 'true' ? 'Completado' : 'Pendiente';
            
            document.getElementById('debugFooter').innerText = `Debug: Onboarding=${onbStatus} | FirstMsg=${isFirstMessage}`;
            
            // Actualizar status bar
            const statusEl = document.getElementById('statusIndicator');
            statusEl.innerText = currentSessionId ? 'Session Active' : 'Idle';
            statusEl.style.background = currentSessionId ? '#48bb78' : 'rgba(0,0,0,0.2)';
        }

        function showView(viewId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            // Mostrar la deseada
            document.getElementById(viewId).classList.add('active');
            logAction('NAV', 'Navegando a ' + viewId);
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        // --- L√ìGICA ONBOARDING ---
        function checkOnboarding() {
            const complete = localStorage.getItem('claraflow_onboarding_complete');
            if (complete === 'true') {
                showView('viewDashboard');
            } else {
                showView('viewOnboarding');
            }
        }

        function nextStep(stepNum) {
            document.querySelectorAll('.onboarding-step').forEach(el => el.classList.remove('active-step'));
            document.getElementById('step' + stepNum).classList.add('active-step');
        }

        function finishOnboarding() {
            localStorage.setItem('claraflow_onboarding_complete', 'true');
            logAction('ONBOARDING', 'Completado');
            updateDebugInfo();
            showView('viewDashboard');
        }

        // --- L√ìGICA DASHBOARD ---
        function resetLocal() {
            localStorage.clear();
            location.reload();
        }

        async function startSession() {
            const btn = document.querySelector('#viewDashboard .btn-primary');
            btn.innerHTML = "Creando sesi√≥n...";
            btn.disabled = true;

            try {
                const response = await fetch(SESSION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        phase: "start"
                    })
                });

                if (!response.ok) throw new Error('Error en API Session');
                
                const data = await response.json();
                
                // Asumimos que la respuesta trae el session_id. 
                // Ajustar seg√∫n la estructura real de respuesta si es necesario.
                // Generalmente: { session_id: "...", ... } o data es el string.
                // Como no especificaste la estructura de respuesta, asumo data.session_id o data directo.
                currentSessionId = data.session_id || data.id || (typeof data === 'string' ? data : null);
                
                if (!currentSessionId) {
                    console.warn("No se encontr√≥ session_id obvio, usando fallback o logueando data entera:", data);
                    // Fallback para demo si la API no devuelve exactamente session_id en root
                    if (data.data && data.data.session_id) currentSessionId = data.data.session_id;
                }

                if(currentSessionId) {
                    localStorage.setItem('claraflow_session_id', currentSessionId);
                    logAction('API', 'Sesi√≥n creada: ' + currentSessionId);
                    updateDebugInfo();
                    
                    document.getElementById('activeSessionCard').style.display = 'block';
                    document.getElementById('decisionArea').classList.remove('hidden');
                    
                    showView('viewClarification');
                } else {
                    throw new Error('No se recibi√≥ Session ID v√°lido');
                }

            } catch (error) {
                console.error(error);
                alert("Error al crear sesi√≥n: " + error.message);
            } finally {
                btn.innerHTML = "Iniciar Sesi√≥n de Trabajo";
                btn.disabled = false;
            }
        }

        async function registerDecision() {
            if (!currentSessionId) return;
            const text = document.getElementById('decisionText').value;
            if(!text) return alert("Escribe una decisi√≥n.");

            try {
                const response = await fetch(DECIDE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        session_id: currentSessionId,
                        decision_text: text,
                        context: "Web Client Decision"
                    })
                });
                
                if(response.ok) {
                    alert("Decisi√≥n registrada correctamente.");
                    document.getElementById('decisionText').value = "";
                } else {
                    throw new Error('Error al registrar decisi√≥n');
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // --- L√ìGICA CLARIFICACI√ìN & CHAT ---
        
        // Maneja el paso de Vista 3 a Vista 4 (Primer mensaje)
        async function handleFirstMessage() {
            const input = document.getElementById('clarificationInput');
            const text = input.value.trim();
            
            if (!text) return alert("Por favor escribe algo para comenzar.");
            if (!currentSessionId) return alert("Error de sesi√≥n: No hay ID de sesi√≥n activo.");

            // 1. Navegar a VISTA 4
            showView('viewChat');
            
            // 2. Crear div de chat (limpiar anterior si existe)
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = ''; // Limpiar historial visual previo

            // 3. Agregar mensaje del sistema
            addBubble('system', "Cuando quieras, dime qu√© es eso que ahora mismo te gustar√≠a aclarar.");

            // 4. Agregar mensaje del usuario (visual)
            addBubble('user', text);
            input.value = ''; // Limpiar input de clarificaci√≥n

            // 5. POST a IF_URL
            await postToIfLoop(text);
            
            // 7. Marcar flag
            isFirstMessage = false;
            updateDebugInfo();
        }

        // Env√≠o de mensajes desde la Vista 4 (Chat continuo)
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            addBubble('user', text);
            input.value = '';
            
            await postToIfLoop(text);
        }

        // Funci√≥n centralizada para llamar a la API IF Loop
        async function postToIfLoop(text) {
            // Indicador de carga visual (opcional, pero √∫til)
            const loadingId = addBubble('system', 'Clara est√° pensando...', true);

            try {
                const response = await fetch(IF_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        session_id: currentSessionId,
                        text: text
                    })
                });

                // Remover loading
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                
                // Asumiendo que la respuesta es texto plano o un JSON con campo 'message' o 'reply'
                // Ajustar seg√∫n respuesta real. Usaremos JSON.stringify si es objeto complejo para debug.
                let replyText = "Respuesta vac√≠a";
                if (typeof data === 'string') replyText = data;
                else if (data.message) replyText = data.message;
                else if (data.reply) replyText = data.reply;
                else if (data.text) replyText = data.text;
                else replyText = JSON.stringify(data); // Fallback

                addBubble('bot', replyText);

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();
                
                console.error(error);
                addBubble('error', 'Error de conexi√≥n: ' + error.message);
            }
        }

        // Helper para crear burbujas de chat
        function addBubble(type, text, isTemp = false) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            
            div.classList.add('msg');
            
            if (type === 'user') div.classList.add('msg-user');
            else if (type === 'bot') div.classList.add('msg-bot');
            else if (type === 'system') div.classList.add('msg-system');
            else if (type === 'error') div.classList.add('msg-error');
            
            div.innerText = text;
            
            const id = 'msg-' + Date.now() + Math.random();
            div.id = id;
            
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            
            return id;
        }

    </script>
</body>
</html>
