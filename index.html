<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClaraFlow</title>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:rgba(255,255,255,.22);
      --shadow:0 18px 45px rgba(0,0,0,.22);
      --shadow2:0 10px 28px rgba(0,0,0,.18);
      --radius:18px;
      --radius2:14px;
      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#ffffff;
      --btn2Text:#111827;
      --danger:#ef4444;
      --success:#10b981;
      --warn:#f59e0b;
      --focus:rgba(102,126,234,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --maxw: 980px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .app{
      width: min(var(--maxw), 100%);
      min-height: 560px;
      background: rgba(255,255,255,.10);
      border: 1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      color: white;
    }

    .logo{
      width:38px;
      height:38px;
      border-radius: 12px;
      background: rgba(255,255,255,.22);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.25);
      user-select:none;
    }

    .brand h1{
      margin:0;
      font-size: 16px;
      line-height: 1.2;
      letter-spacing: .2px;
    }

    .brand .sub{
      font-size: 12px;
      opacity: .86;
      margin-top: 2px;
    }

    .status{
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,.92);
      font-size: 12px;
    }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }

    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(255,255,255,.65);
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
    }

    .dot.ok{ background: var(--success); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--danger); }

    .main{
      display:flex;
      gap: 18px;
      padding: 18px;
      flex:1;
      min-height: 0;
    }

    .panel{
      flex:1;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow2);
      min-height: 0;
    }

    .panel h2{
      margin: 0 0 8px 0;
      font-size: 18px;
      color: white;
      letter-spacing: .2px;
    }

    .panel p{
      margin: 0 0 14px 0;
      color: rgba(255,255,255,.88);
      font-size: 14px;
      line-height: 1.45;
    }

    .card{
      background: rgba(255,255,255,.95);
      border-radius: var(--radius2);
      padding: 14px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
      color: var(--text);
    }

    .views{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .view{
      display:none;
      flex:1;
      min-height:0;
    }
    .view.active{ display:flex; }

    .ob-wrap{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .ob-card{
      width: min(720px, 100%);
      background: rgba(255,255,255,.95);
      border-radius: 22px;
      padding: 20px 18px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
    }

    .ob-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .ob-title{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
    }

    .ob-step{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(0,0,0,.55);
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.08);
      padding: 6px 10px;
      border-radius: 999px;
      user-select:none;
    }

    .ob-body{
      color: rgba(0,0,0,.78);
      font-size: 14px;
      line-height: 1.55;
      margin: 10px 0 14px 0;
    }

    .ob-list{
      margin: 10px 0 0 18px;
      padding:0;
    }
    .ob-list li{ margin: 6px 0; }

    .ob-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 14px;
    }

    .dash-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
      width:100%;
      min-height:0;
    }
    @media (max-width: 860px){
      .main{ flex-direction:column; }
      .dash-grid{ grid-template-columns: 1fr; }
    }

    .section{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .hint{
      font-size: 12px;
      color: rgba(0,0,0,.60);
      line-height:1.4;
    }

    .kv{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 8px 10px;
      font-size: 12px;
      color: rgba(0,0,0,.72);
      border: 1px dashed rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255,255,255,.7);
    }
    .kv .k{ color: rgba(0,0,0,.52); }
    .kv code{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow-wrap:anywhere;
    }

    .clarify{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0;
    }

    .clarify-card{
      width: min(820px, 100%);
      background: rgba(255,255,255,.95);
      border-radius: 22px;
      padding: 18px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .clarify-card h2{
      margin:0;
      font-size: 20px;
    }

    .clarify-card p{
      margin:0;
      color: rgba(0,0,0,.75);
      font-size: 14px;
      line-height: 1.55;
    }

    .chat{
      width:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
      gap: 12px;
    }

    .chat-card{
      flex:1;
      min-height:0;
      background: rgba(255,255,255,.95);
      border-radius: 22px;
      padding: 14px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .chat-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .chat-top h2{
      margin:0;
      font-size: 18px;
    }

    .chatlog{
      flex:1;
      min-height: 0;
      overflow:auto;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.03);
      border: 1px solid rgba(0,0,0,.06);
    }

    .msg{
      display:flex;
      margin: 10px 0;
      gap: 10px;
      align-items:flex-start;
    }
    .msg .avatar{
      width:34px;
      height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      font-size: 14px;
      border: 1px solid rgba(0,0,0,.08);
      user-select:none;
      flex: 0 0 auto;
    }
    .msg.user .avatar{ background: rgba(17,24,39,.10); }
    .msg.bot .avatar{ background: rgba(102,126,234,.14); }
    .msg.system .avatar{ background: rgba(245,158,11,.16); }

    .bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background: white;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .msg.user .bubble{
      background: rgba(17,24,39,.92);
      color:white;
      border-color: rgba(17,24,39,.92);
      margin-left:auto;
    }
    .msg.user{ flex-direction: row-reverse; }
    .msg.user .bubble{ border-top-right-radius: 8px; }
    .msg.bot .bubble{ border-top-left-radius: 8px; }
    .msg.system .bubble{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.25);
      color: rgba(0,0,0,.78);
    }

    .composer{
      display:flex;
      gap: 10px;
      align-items:center;
    }

    input[type="text"]{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      background: rgba(255,255,255,.96);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input[type="text"]:focus{
      border-color: rgba(102,126,234,.45);
      box-shadow: 0 0 0 4px var(--focus);
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-primary{
      background: var(--btn);
      color: var(--btnText);
      border-color: rgba(0,0,0,.18);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .btn-primary:hover{ box-shadow: 0 14px 28px rgba(0,0,0,.22); }

    .btn-secondary{
      background: var(--btn2);
      color: var(--btn2Text);
    }
    .btn-secondary:hover{ box-shadow: 0 14px 28px rgba(0,0,0,.12); }

    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .mini{
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(17,24,39,.94);
      color: white;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      display:none;
      max-width: min(720px, calc(100% - 26px));
      font-size: 13px;
      line-height: 1.35;
      z-index: 9999;
    }
    .toast.show{ display:block; }

    .footer{
      padding: 12px 18px;
      border-top: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.82);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .footer code{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      overflow-wrap:anywhere;
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">CF</div>
        <div>
          <h1>ClaraFlow</h1>
          <div class="sub">Decisiones claras, paso a paso</div>
        </div>
      </div>

      <div class="status">
        <div class="pill" title="Estado de la app">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Listo</span>
        </div>
        <div class="pill" title="Usuario / Sesi√≥n">
          <span>user:</span>
          <code id="userCode">-</code>
          <span>session:</span>
          <code id="sessionCode">-</code>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="views">

        <!-- VIEW: ONBOARDING -->
        <section class="view" id="viewOnboarding" aria-label="Onboarding">
          <div class="ob-wrap">
            <div class="ob-card">
              <div class="ob-head">
                <h2 class="ob-title" id="obTitle">‚Äî</h2>
                <div class="ob-step" id="obStep">Paso 1/4</div>
              </div>
              <div class="ob-body" id="obBody">‚Äî</div>

              <div class="ob-actions" id="obActions">
                <button class="btn btn-primary" id="btn-continuar">Continuar</button>
                <button class="btn btn-primary" id="btn-siguiente" style="display:none">Siguiente</button>
                <button class="btn btn-primary" id="btn-entendido" style="display:none">Entendido</button>
                <button class="btn btn-primary" id="btn-comenzar" style="display:none">Comenzar</button>
              </div>
            </div>
          </div>
        </section>

        <!-- VIEW: DASHBOARD -->
        <section class="view" id="viewDashboard" aria-label="Dashboard">
          <div class="dash-grid">
            <div class="panel">
              <h2>Dashboard</h2>
              <p>Gestiona tus sesiones y registra decisiones. El flujo se activa al iniciar una sesi√≥n y enviar el primer mensaje de clarificaci√≥n.</p>

              <div class="card section">
                <h3 style="margin:0 0 2px 0; font-size:16px;">1) Crear nueva sesi√≥n</h3>
                <div class="hint">
                  Crea una sesi√≥n de trabajo en el backend. Al completarse, pasar√°s a la pantalla de clarificaci√≥n.
                </div>
                <div class="row">
                  <button class="btn btn-primary" id="createSession">Iniciar Sesi√≥n de Trabajo</button>
                  <button class="btn btn-secondary" id="resetApp" title="Reiniciar onboarding y estado (solo local)">Reset local</button>
                </div>

                <div class="kv" style="margin-top:8px;">
                  <div class="k">user_id</div>
                  <div><code id="kvUserId">‚Äî</code></div>
                  <div class="k">session_id</div>
                  <div><code id="kvSessionId">‚Äî</code></div>
                  <div class="k">onboarding</div>
                  <div><code id="kvOnboarding">‚Äî</code></div>
                </div>
              </div>

              <div class="card section">
                <h3 style="margin:0 0 2px 0; font-size:16px;">2) Registrar decisi√≥n</h3>
                <div class="hint">
                  Disponible una vez exista <span style="font-family:var(--mono)">session_id</span>.
                </div>
                <div class="row">
                  <button class="btn btn-primary" id="makeDecision" disabled>Registrar Decisi√≥n</button>
                  <span class="hint" id="decisionStatus" aria-live="polite"></span>
                </div>
              </div>
            </div>

            <div class="panel">
              <h2>Estado</h2>
              <p>Visibilidad para depuraci√≥n (solo UI). No se muestran JSON de respuestas al usuario.</p>

              <div class="card section">
                <h3 style="margin:0 0 6px 0; font-size:16px;">Accesos r√°pidos</h3>
                <div class="row">
                  <button class="btn btn-secondary mini" id="goToClarification" disabled>Ir a clarificaci√≥n</button>
                  <button class="btn btn-secondary mini" id="goToChat" disabled>Ir al chat</button>
                </div>
                <div class="hint" style="margin-top:6px;">
                  El chat aparece tras el primer mensaje en clarificaci√≥n.
                </div>
              </div>

              <div class="card section">
                <h3 style="margin:0 0 6px 0; font-size:16px;">Diagn√≥stico</h3>
                <div class="hint">
                  Si alg√∫n bot√≥n no responde, abre la consola del navegador y revisa los logs (se imprimen en cada acci√≥n).
                </div>
                <div class="hint" style="margin-top:8px;">
                  Consejo: prueba primero ‚ÄúIniciar Sesi√≥n de Trabajo‚Äù y luego escribe un mensaje en clarificaci√≥n.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- VIEW: CLARIFICATION -->
        <section class="view" id="viewClarification" aria-label="Clarificaci√≥n">
          <div class="clarify">
            <div class="clarify-card">
              <h2>Aclaremos una cosa</h2>
              <p>
                No hace falta contarlo todo. Piensa en una situaci√≥n, decisi√≥n o asunto concreto que ahora mismo te genera ruido.
                Vamos a mirarlo con calma para ganar un poco m√°s de claridad.
              </p>

              <div class="composer">
                <label class="sr-only" for="ifInput">Mensaje</label>
                <input id="ifInput" type="text" placeholder="Cu√©ntame qu√© est√° pasando..." />
                <button class="btn btn-primary" id="ifSendBtn">Enviar</button>
              </div>

              <div class="hint">
                Al enviar el primer mensaje, se abrir√° el historial del chat y se enviar√° al backend.
              </div>
            </div>
          </div>
        </section>

        <!-- VIEW: IF LOOP CHAT -->
        <section class="view" id="viewChat" aria-label="Chat IF Loop">
          <div class="chat">
            <div class="chat-card">
              <div class="chat-top">
                <h2>IF Loop</h2>
                <div class="row">
                  <button class="btn btn-secondary mini" id="backToDashboard">Dashboard</button>
                  <button class="btn btn-secondary mini" id="backToClarification">Clarificaci√≥n</button>
                </div>
              </div>

              <div class="chatlog" id="ifChat" style="display:none"></div>

              <div class="composer">
                <label class="sr-only" for="chatInput">Escribe un mensaje</label>
                <input id="chatInput" type="text" placeholder="Escribe aqu√≠..." />
                <button class="btn btn-primary" id="chatSendBtn">Enviar</button>
              </div>

              <div class="hint">
                Se env√≠a al backend y se muestra solo el <span style="font-family:var(--mono)">reply</span> de la respuesta.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

    <div class="footer">
      <div>ClaraFlow ‚Ä¢ Single-file HTML ‚Ä¢ Sin dependencias</div>
      <div>
        <span>Onboarding:</span> <code id="footerOnboarding">‚Äî</code>
        <span style="margin-left:10px;">FirstMsg:</span> <code id="footerFirstMsg">‚Äî</code>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    /**************************************************************************
     * ClaraFlow - Single file HTML app (CORREGIDO)
     * Fixes incluidos:
     * 1) SUPABASE_ANON_KEY corregida (seg√∫n reporte)
     * 2) user_id incluido en payload IF y DECIDE (ya estaba, se mantiene expl√≠cito)
     * 3) extracci√≥n de session_id m√°s robusta y logs de respuesta
     *************************************************************************/

    /* ===========================
       Backend constants
    =========================== */
    const SESSION_URL = 'https://claramente-edge-prod.vercel.app/api/clara-flow-session';
    const IF_URL      = 'https://claramente-edge-prod.vercel.app/api/if-loop-message';
    const DECIDE_URL  = 'https://claramente-edge-prod.vercel.app/api/claraflow-decide';

    // FIX 1: Key correcta (la del reporte)
    const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRramVwc3FncXRqbWlieGdhaXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MDU4NDcsImV4cCI6MjA1MzM4MTg0N30.YH0RfmwXc3FncXRQqbHlidGdhX1pEzNTI3NzcyNy1jYzE2LTQ0YjgtYmZjMi1iZTEzMDg3N2Y3ZmE";

    /* ===========================
       Global variables (required)
    =========================== */
    let currentSessionId = null;
    let currentUserId = 'demo-user-' + Date.now();
    let isFirstMessage = true;

    /* ===========================
       DOM references
    =========================== */
    let viewOnboarding, viewDashboard, viewClarification, viewChat;
    let obTitle, obBody, obStep;
    let btnContinuar, btnSiguiente, btnEntendido, btnComenzar;

    let btnCreateSession, btnMakeDecision, btnResetApp;
    let decisionStatus;
    let goToClarification, goToChat;

    let kvUserId, kvSessionId, kvOnboarding;
    let ifInput, ifSendBtn;

    let ifChat, chatInput, chatSendBtn;
    let backToDashboard, backToClarification;

    let statusDot, statusText, userCode, sessionCode;
    let footerOnboarding, footerFirstMsg;
    let toastEl;

    /* ===========================
       State helpers
    =========================== */
    function log(){
      console.log.apply(console, arguments);
    }

    function setStatus(kind, text){
      log('[STATUS]', kind, text);
      statusText.textContent = text || '‚Äî';
      statusDot.classList.remove('ok','warn','bad');
      if(kind === 'ok') statusDot.classList.add('ok');
      else if(kind === 'warn') statusDot.classList.add('warn');
      else if(kind === 'bad') statusDot.classList.add('bad');
    }

    function showToast(message, ms){
      if(!toastEl) return;
      toastEl.textContent = message || '';
      toastEl.classList.add('show');
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(function(){
        toastEl.classList.remove('show');
      }, typeof ms === 'number' ? ms : 2600);
    }

    function safeText(s){
      if(s === null || s === undefined) return '';
      return String(s);
    }

    function updateHeaderCodes(){
      userCode.textContent = currentUserId ? currentUserId : '-';
      sessionCode.textContent = currentSessionId ? currentSessionId : '-';
    }

    function isOnboardingComplete(){
      return localStorage.getItem('claraflow_onboarding_complete') === 'true';
    }

    function setOnboardingComplete(){
      localStorage.setItem('claraflow_onboarding_complete', 'true');
      log('[ONBOARDING] set claraflow_onboarding_complete = true');
      updateDashboardKV();
    }

    function updateDashboardKV(){
      kvUserId.textContent = currentUserId || '‚Äî';
      kvSessionId.textContent = currentSessionId || '‚Äî';
      kvOnboarding.textContent = isOnboardingComplete() ? 'true' : 'false';

      footerOnboarding.textContent = isOnboardingComplete() ? 'true' : 'false';
      footerFirstMsg.textContent = isFirstMessage ? 'true' : 'false';

      btnMakeDecision.disabled = !currentSessionId;
      goToClarification.disabled = !currentSessionId;
      goToChat.disabled = isFirstMessage;

      updateHeaderCodes();
    }

    function resetLocal(){
      log('[RESET] Clearing local onboarding + resetting session/firstMessage');
      localStorage.removeItem('claraflow_onboarding_complete');
      currentSessionId = null;
      isFirstMessage = true;
      ifChat.innerHTML = '';
      ifChat.style.display = 'none';
      decisionStatus.textContent = '';
      chatInput.value = '';
      ifInput.value = '';
      updateDashboardKV();
      setStatus('warn','Estado reiniciado (local)');
      showToast('Estado local reiniciado');
      showView('onboarding');
      renderOnboardingStep(1);
    }

    /* ===========================
       View management
    =========================== */
    function showView(name){
      log('[NAV] showView:', name);
      viewOnboarding.classList.remove('active');
      viewDashboard.classList.remove('active');
      viewClarification.classList.remove('active');
      viewChat.classList.remove('active');

      if(name === 'onboarding') viewOnboarding.classList.add('active');
      else if(name === 'dashboard') viewDashboard.classList.add('active');
      else if(name === 'clarification') viewClarification.classList.add('active');
      else if(name === 'chat') viewChat.classList.add('active');
      else viewDashboard.classList.add('active');

      updateDashboardKV();
    }

    /* ===========================
       Onboarding
    =========================== */
    const onboardingSteps = {
      1: {
        title: '¬°Bienvenido a ClaraFlow! üéØ',
        body: 'ClaraFlow te ayuda a tomar decisiones claras y organizadas mediante un sistema inteligente de flujo de trabajo.',
        btnToShow: 'btn-continuar'
      },
      2: {
        title: '¬øC√≥mo funciona? ü§î',
        body: (
          '<ol class="ob-list">' +
            '<li>Crea una sesi√≥n de trabajo</li>' +
            '<li>Define tu decisi√≥n</li>' +
            '<li>Sigue el flujo guiado</li>' +
            '<li>Obt√©n claridad en tus decisiones</li>' +
          '</ol>'
        ),
        btnToShow: 'btn-siguiente'
      },
      3: {
        title: 'Tu privacidad importa üîí',
        body: 'Todas tus decisiones se guardan de forma segura. Solo t√∫ tienes acceso a tu informaci√≥n.',
        btnToShow: 'btn-entendido'
      },
      4: {
        title: '¬°Listo para empezar! üöÄ',
        body: 'Vamos a comenzar tu primera sesi√≥n de ClaraFlow.',
        btnToShow: 'btn-comenzar'
      }
    };

    function renderOnboardingStep(step){
      log('[ONBOARDING] render step', step);
      const s = onboardingSteps[step];
      if(!s){ log('[ONBOARDING] invalid step', step); return; }

      obTitle.textContent = s.title;
      if(step === 2) obBody.innerHTML = s.body;
      else obBody.textContent = s.body;

      obStep.textContent = 'Paso ' + step + '/4';

      btnContinuar.style.display = 'none';
      btnSiguiente.style.display = 'none';
      btnEntendido.style.display = 'none';
      btnComenzar.style.display = 'none';

      if(s.btnToShow === 'btn-continuar') btnContinuar.style.display = 'inline-flex';
      if(s.btnToShow === 'btn-siguiente') btnSiguiente.style.display = 'inline-flex';
      if(s.btnToShow === 'btn-entendido') btnEntendido.style.display = 'inline-flex';
      if(s.btnToShow === 'btn-comenzar') btnComenzar.style.display = 'inline-flex';
    }

    /* ===========================
       Networking helpers
    =========================== */
    async function postJson(url, headers, bodyObj){
      log('[HTTP] POST', url, bodyObj);

      let resp;
      try{
        resp = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(bodyObj)
        });
      }catch(netErr){
        log('[HTTP] Network error:', netErr);
        throw new Error('Error de red. Revisa tu conexi√≥n o CORS.');
      }

      let text = '';
      try{ text = await resp.text(); }catch(e){}

      let json = null;
      if(text){
        try{ json = JSON.parse(text); }catch(e){ json = null; }
      }

      log('[HTTP] Response status:', resp.status, resp.statusText);
      if(text) log('[HTTP] Raw response body:', text);

      if(!resp.ok){
        const serverMsg = (json && (json.error || json.message)) ? (json.error || json.message) : '';
        const msg = 'HTTP ' + resp.status + ' ' + resp.statusText + (serverMsg ? ' ‚Äî ' + serverMsg : '');
        log('[HTTP] Error response:', msg);
        throw new Error(msg);
      }

      return json !== null ? json : {};
    }

    /* ===========================
       Session creation
    =========================== */
    function extractSessionId(data){
      // FIX 3: extracci√≥n m√°s robusta + logs
      // Probables:
      // - data.session_id
      // - data.sessionId
      // - data.id
      // - data.session?.id
      // - data.data?.session_id (si envoltorio)
      log('[SESSION] extractSessionId from:', data);

      if(!data) return null;

      if(typeof data.session_id === 'string' && data.session_id) return data.session_id;
      if(typeof data.sessionId === 'string' && data.sessionId) return data.sessionId;
      if(typeof data.id === 'string' && data.id) return data.id;

      if(data.session && typeof data.session.id === 'string' && data.session.id) return data.session.id;
      if(data.data && typeof data.data.session_id === 'string' && data.data.session_id) return data.data.session_id;
      if(data.data && typeof data.data.sessionId === 'string' && data.data.sessionId) return data.data.sessionId;
      if(data.data && typeof data.data.id === 'string' && data.data.id) return data.data.id;

      return null;
    }

    async function handleCreateSession(){
      log('[ACTION] createSession clicked');
      setStatus('warn','Creando sesi√≥n...');
      showToast('Creando sesi√≥n...');
      btnCreateSession.disabled = true;

      try{
        const headers = {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
        };

        const body = {
          user_id: currentUserId,
          phase: 'start'
        };

        const data = await postJson(SESSION_URL, headers, body);
        const sid = extractSessionId(data);

        if(!sid){
          throw new Error('Respuesta sin session_id (o equivalente). Revisa el log de respuesta en consola.');
        }

        currentSessionId = sid;
        log('[SESSION] Created session_id:', currentSessionId);

        updateDashboardKV();
        setStatus('ok','Sesi√≥n creada');
        showToast('Sesi√≥n creada');

        showView('clarification');

      }catch(err){
        log('[SESSION] Failed:', err);
        setStatus('bad','Error creando sesi√≥n');
        showToast('Error: ' + safeText(err.message), 4200);
      }finally{
        btnCreateSession.disabled = false;
        updateDashboardKV();
      }
    }

    /* ===========================
       Decision registration
    =========================== */
    async function handleMakeDecision(){
      log('[ACTION] makeDecision clicked');

      if(!currentSessionId){
        showToast('Primero crea una sesi√≥n.');
        return;
      }

      setStatus('warn','Registrando decisi√≥n...');
      decisionStatus.textContent = '';
      btnMakeDecision.disabled = true;

      try{
        const headers = {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
        };

        // FIX 2: user_id requerido (explicitado)
        const body = {
          user_id: currentUserId,
          session_id: currentSessionId,
          decision_text: 'Decisi√≥n de prueba ClaraFlow',
          context: { source: 'web_ui' }
        };

        await postJson(DECIDE_URL, headers, body);

        decisionStatus.textContent = '‚úÖ Decisi√≥n registrada!';
        setStatus('ok','Decisi√≥n registrada');
        showToast('‚úÖ Decisi√≥n registrada!');

      }catch(err){
        log('[DECIDE] Failed:', err);
        decisionStatus.textContent = '‚ö†Ô∏è Error al registrar la decisi√≥n.';
        setStatus('bad','Error registrando decisi√≥n');
        showToast('Error: ' + safeText(err.message), 4200);
      }finally{
        btnMakeDecision.disabled = !currentSessionId;
        updateDashboardKV();
      }
    }

    /* ===========================
       Chat rendering
    =========================== */
    function appendMessage(role, text){
      const msg = document.createElement('div');
      msg.className = 'msg ' + role;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      if(role === 'user') avatar.textContent = 'T√∫';
      else if(role === 'bot') avatar.textContent = 'Clara';
      else avatar.textContent = '‚Ä¢';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = safeText(text);

      msg.appendChild(avatar);
      msg.appendChild(bubble);

      ifChat.appendChild(msg);
      ifChat.scrollTop = ifChat.scrollHeight;
    }

    function ensureChatVisible(){
      ifChat.style.display = 'block';
      updateDashboardKV();
    }

    /* ===========================
       IF Loop backend call
    =========================== */
    async function sendIfMessage(text){
      log('[IF] send message:', text);

      if(!currentSessionId){
        throw new Error('No hay sesi√≥n activa. Crea una sesi√≥n primero.');
      }

      const headers = { 'Content-Type': 'application/json' };

      // FIX 2: user_id requerido (explicitado)
      const body = {
        user_id: currentUserId,
        session_id: currentSessionId,
        text: text
      };

      const data = await postJson(IF_URL, headers, body);

      const reply = (data && typeof data.reply === 'string') ? data.reply : '';
      if(!reply){
        log('[IF] Missing reply field:', data);
        throw new Error('Respuesta sin campo "reply". Revisa el log de respuesta en consola.');
      }

      return reply;
    }

    /* ===========================
       Clarification first message flow
    =========================== */
    async function handleClarificationSend(){
      log('[ACTION] ifSendBtn clicked');

      const text = safeText(ifInput.value).trim();
      if(!text){
        showToast('Escribe un mensaje primero.');
        return;
      }
      ifInput.value = '';

      if(!currentSessionId){
        showToast('Primero crea una sesi√≥n en el dashboard.');
        setStatus('warn','Falta sesi√≥n');
        return;
      }

      try{
        setStatus('warn','Enviando...');

        if(isFirstMessage){
          log('[FLOW] First message -> switch to chat');
          showView('chat');
          ensureChatVisible();

          appendMessage('system','Cuando quieras, dime qu√© es eso que ahora mismo te gustar√≠a aclarar.');
          appendMessage('user', text);

          isFirstMessage = false;
          updateDashboardKV();
        }else{
          showView('chat');
          ensureChatVisible();
          appendMessage('user', text);
        }

        const reply = await sendIfMessage(text);
        appendMessage('bot', reply);

        setStatus('ok','Respuesta recibida');

      }catch(err){
        log('[FLOW] handleClarificationSend error:', err);
        appendMessage('system','‚ö†Ô∏è Error: ' + safeText(err.message));
        setStatus('bad','Error enviando');
        showToast('Error: ' + safeText(err.message), 4200);
      }
    }

    /* ===========================
       Chat send flow
    =========================== */
    async function handleChatSend(){
      log('[ACTION] chatSendBtn clicked');

      const text = safeText(chatInput.value).trim();
      if(!text){
        showToast('Escribe un mensaje primero.');
        return;
      }
      chatInput.value = '';

      if(!currentSessionId){
        showToast('Primero crea una sesi√≥n en el dashboard.');
        setStatus('warn','Falta sesi√≥n');
        return;
      }

      try{
        setStatus('warn','Enviando...');
        ensureChatVisible();

        appendMessage('user', text);

        const reply = await sendIfMessage(text);
        appendMessage('bot', reply);

        setStatus('ok','Respuesta recibida');
        updateDashboardKV();

      }catch(err){
        log('[CHAT] handleChatSend error:', err);
        appendMessage('system','‚ö†Ô∏è Error: ' + safeText(err.message));
        setStatus('bad','Error enviando');
        showToast('Error: ' + safeText(err.message), 4200);
      }
    }

    /* ===========================
       Keyboard helper
    =========================== */
    function bindEnterToSend(inputEl, buttonEl, label){
      inputEl.addEventListener('keydown', function(ev){
        if(ev.key === 'Enter'){
          ev.preventDefault();
          log('[KEY] Enter pressed in', label);
          buttonEl.click();
        }
      });
    }

    /* ===========================
       Direct event listeners
    =========================== */
    function bindEvents(){
      log('[INIT] Binding events (direct listeners)');

      btnContinuar.addEventListener('click', function(){
        log('[BTN] btn-continuar');
        renderOnboardingStep(2);
      });

      btnSiguiente.addEventListener('click', function(){
        log('[BTN] btn-siguiente');
        renderOnboardingStep(3);
      });

      btnEntendido.addEventListener('click', function(){
        log('[BTN] btn-entendido');
        renderOnboardingStep(4);
      });

      btnComenzar.addEventListener('click', function(){
        log('[BTN] btn-comenzar');
        setOnboardingComplete();
        setStatus('ok','Onboarding completo');
        showToast('Onboarding completado');
        showView('dashboard');
      });

      btnCreateSession.addEventListener('click', function(){
        handleCreateSession();
      });

      btnMakeDecision.addEventListener('click', function(){
        handleMakeDecision();
      });

      btnResetApp.addEventListener('click', function(){
        resetLocal();
      });

      goToClarification.addEventListener('click', function(){
        log('[BTN] goToClarification');
        if(!currentSessionId){
          showToast('Primero crea una sesi√≥n.');
          return;
        }
        showView('clarification');
      });

      goToChat.addEventListener('click', function(){
        log('[BTN] goToChat');
        if(isFirstMessage){
          showToast('El chat se habilita tras el primer mensaje.');
          return;
        }
        showView('chat');
        ensureChatVisible();
      });

      ifSendBtn.addEventListener('click', function(){
        handleClarificationSend();
      });

      chatSendBtn.addEventListener('click', function(){
        handleChatSend();
      });

      backToDashboard.addEventListener('click', function(){
        log('[BTN] backToDashboard');
        showView('dashboard');
      });

      backToClarification.addEventListener('click', function(){
        log('[BTN] backToClarification');
        if(!currentSessionId){
          showToast('Primero crea una sesi√≥n.');
          showView('dashboard');
          return;
        }
        showView('clarification');
      });

      bindEnterToSend(ifInput, ifSendBtn, 'ifInput');
      bindEnterToSend(chatInput, chatSendBtn, 'chatInput');
    }

    /* ===========================
       DOM initialization
    =========================== */
    function cacheDom(){
      viewOnboarding    = document.getElementById('viewOnboarding');
      viewDashboard     = document.getElementById('viewDashboard');
      viewClarification = document.getElementById('viewClarification');
      viewChat          = document.getElementById('viewChat');

      obTitle = document.getElementById('obTitle');
      obBody  = document.getElementById('obBody');
      obStep  = document.getElementById('obStep');

      btnContinuar = document.getElementById('btn-continuar');
      btnSiguiente = document.getElementById('btn-siguiente');
      btnEntendido = document.getElementById('btn-entendido');
      btnComenzar  = document.getElementById('btn-comenzar');

      btnCreateSession = document.getElementById('createSession');
      btnMakeDecision  = document.getElementById('makeDecision');
      btnResetApp      = document.getElementById('resetApp');
      decisionStatus   = document.getElementById('decisionStatus');
      goToClarification= document.getElementById('goToClarification');
      goToChat         = document.getElementById('goToChat');

      kvUserId     = document.getElementById('kvUserId');
      kvSessionId  = document.getElementById('kvSessionId');
      kvOnboarding = document.getElementById('kvOnboarding');

      ifInput   = document.getElementById('ifInput');
      ifSendBtn = document.getElementById('ifSendBtn');

      ifChat      = document.getElementById('ifChat');
      chatInput   = document.getElementById('chatInput');
      chatSendBtn = document.getElementById('chatSendBtn');

      backToDashboard     = document.getElementById('backToDashboard');
      backToClarification = document.getElementById('backToClarification');

      statusDot  = document.getElementById('statusDot');
      statusText = document.getElementById('statusText');
      userCode   = document.getElementById('userCode');
      sessionCode= document.getElementById('sessionCode');

      footerOnboarding = document.getElementById('footerOnboarding');
      footerFirstMsg   = document.getElementById('footerFirstMsg');

      toastEl = document.getElementById('toast');

      const required = [
        viewOnboarding, viewDashboard, viewClarification, viewChat,
        btnContinuar, btnSiguiente, btnEntendido, btnComenzar,
        btnCreateSession, btnMakeDecision, btnResetApp,
        ifInput, ifSendBtn, ifChat, chatInput, chatSendBtn
      ];
      for(let i=0;i<required.length;i++){
        if(!required[i]) console.error('[INIT] Missing required DOM element at index', i);
      }
    }

    /* ===========================
       App startup
    =========================== */
    function initApp(){
      log('[INIT] ClaraFlow boot (CORREGIDO)');
      cacheDom();
      bindEvents();

      setStatus('ok','Listo');
      updateHeaderCodes();
      updateDashboardKV();

      // Onboarding route
      if(isOnboardingComplete()){
        log('[INIT] Onboarding complete -> dashboard');
        showView('dashboard');
      }else{
        log('[INIT] Onboarding not complete -> onboarding');
        showView('onboarding');
        renderOnboardingStep(1);
      }

      // Requirement: chat hidden initially
      ifChat.style.display = 'none';

      log('[INIT] Ready');
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ initApp(); });
    }else{
      initApp();
    }
  </script>
</body>
</html>
